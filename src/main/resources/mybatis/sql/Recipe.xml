<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Recipe">

    <sql id="Recipe.selectRecipe">
        SELECT
               seq                   seq
              ,name                  name
              ,status                status
              ,name                  titleInUrl
              ,version               version
              ,type                  type
              ,style_seq             styleSeq
              ,(SELECT B.KOREAN_NAME FROM STYLE B WHERE style_seq = B.SEQ) styleName
              ,brewer                brewer
              ,asst_brewer           asstBrewer
              ,batch_size            batchSize
              ,boil_size             boilSize
              ,boil_time             boilTime
              ,efficiency            efficiency
              ,notes                 notes
              ,og                    og
              ,fg                    fg
              ,primary_age           primaryAge
              ,primary_temp          primaryTemp
              ,secondary_age         secondaryAge
              ,secondary_temp        secondaryTemp
              ,age                   age
              ,age_temp              ageTemp
              ,priming_sugar_name    primingSugarName
              ,read_count            readCount
              ,ATCH_FILE_ID          atchFileId
              ,ATCH_COVER_FILE_ID    atchCoverFileId
              ,(SELECT B.FILENAME FROM FILEINFO B WHERE ATCH_FILE_ID = B.SEQ) atchFileName
              ,(SELECT C.FILENAME FROM FILEINFO C WHERE ATCH_COVER_FILE_ID = C.SEQ) atchCoverFileName
              ,insert_id             insertId
              ,insert_date           insertDate
              ,update_id             updateId
              ,update_date           updateDate
              ,delete_id             deleteId
              ,delete_date           deleteDate
          FROM brewduckdb.RECIPE
    </sql>

    <sql id="Recipe.categoryList">
        SELECT
            A.seq                    seq
            ,A.name                  name
            ,A.name                  titleInUrl
            ,A.version               version
            ,A.type                  type
            ,A.style_seq             styleSeq
            ,(SELECT B.KOREAN_NAME FROM STYLE B WHERE style_seq = B.SEQ) styleName
            ,A.brewer                brewer
            ,(SELECT C.name FROM account C WHERE C.id = brewer) brewerNm
            ,A.asst_brewer           asstBrewer
            ,A.batch_size            batchSize
            ,A.boil_size             boilSize
            ,A.boil_time             boilTime
            ,A.efficiency            efficiency
            ,A.notes                 notes
            ,A.og                    og
            ,A.fg                    fg
            ,A.primary_age           primaryAge
            ,A.primary_temp          primaryTemp
            ,A.secondary_age         secondaryAge
            ,A.secondary_temp        secondaryTemp
            ,A.age                   age
            ,A.age_temp              ageTemp
            ,A.priming_sugar_name    primingSugarName
            ,A.read_count            readCount
            ,A.atch_file_id          atchFileId
            ,A.atch_cover_file_id    atchCoverFileId
            ,(SELECT B.FILENAME FROM FILEINFO B WHERE atch_file_id = B.SEQ) atchFileName
            ,(SELECT C.FILENAME FROM FILEINFO C WHERE atch_cover_file_id = C.SEQ) atchCoverFileName
            ,A.insert_id             insertId
            ,A.insert_date           insertDate
            ,A.update_id             updateId
            ,A.update_date           updateDate
            ,A.delete_id             deleteId
            ,A.delete_date           deleteDate
        FROM brewduckdb.RECIPE A
        LEFT JOIN brewduckdb.STYLE B on B.seq = A.style_seq
        WHERE A.delete_id IS NULL
          AND A.status = 2
    </sql>

    <select id="Recipe.selectRecipeList" parameterType="Recipe" resultType="Recipe">
        select
        R.*
        ,IFNULL((SELECT 1 FROM RECIPE_FERMENTABLE A WHERE A.brewer = R.brewer AND A.recipe_seq = R.seq LIMIT 1),0)
        +IFNULL((SELECT 1 FROM RECIPE_YEAST A WHERE A.brewer = R.brewer AND A.recipe_seq = R.seq LIMIT 1),0)
        +IFNULL((SELECT 1 FROM RECIPE_HOPS A WHERE A.brewer = R.brewer AND A.recipe_seq = R.seq LIMIT 1),0) as completeness
        FROM (
        <include refid="Recipe.selectRecipe" />
        WHERE delete_id IS NULL
        <if test="brewer != null">
            AND brewer = #{brewer}
        </if>
        ORDER BY  seq desc ) R
    </select>

    <select id="Recipe.selectNewPublicRecipeList" parameterType="Recipe" resultType="Recipe">
        <include refid="Recipe.selectRecipe" />
        WHERE delete_id IS NULL
          AND STATUS = 2
          AND ATCH_COVER_FILE_ID IS NOT NULL
        ORDER BY update_date
        LIMIT 3
    </select>

    <select id="Recipe.selectPublicRecipeMenuList" parameterType="Recipe" resultType="Recipe">
        <include refid="Recipe.selectRecipe" />
        WHERE delete_id IS NULL
        AND STATUS = 2
        AND ATCH_FILE_ID IS NOT NULL
        AND style_seq IN
        <foreach item="a" collection="styleSeqs" open="(" separator="," close=")">
            #{a}
        </foreach>
        ORDER BY update_date
        LIMIT 4
    </select>

    <select id="Recipe.selectRecipeSeq" parameterType="Recipe" resultType="Recipe">
      SELECT IFNULL(MAX(SEQ)+1,1) as seq
        FROM RECIPE
       WHERE brewer =  #{brewer}
    </select>

    <select id="Recipe.selectRecipeDetail" parameterType="Recipe" resultType="Recipe">
        <!-- 맥주 레시피 상세 조회 -->
        <include refid="Recipe.selectRecipe" />
        WHERE delete_id IS NULL
        <if test="seq != null">
            AND seq = #{seq}
        </if>
        <if test="name != null">
            AND name = #{name}
        </if>
        <if test="type != null">
            AND type = #{type}
        </if>
        <if test="brewer != null">
            AND brewer = #{brewer}
        </if>
        <if test="insertId != null">
            AND insert_id = #{insertId}
        </if>
    </select>


    <select id="Recipe.selectCategoryMain" parameterType="Recipe" resultType="Recipe">
        SELECT A.SEQ              seq
               ,A.CATEGORY        category
               ,A.CATEGORY_NUMBER categoryNumber
          FROM STYLE A, STYLE_TEMP B
          WHERE A.name = B.NAME
          AND A.CATEGORY_NUMBER = #{seq}
          LIMIT 1
    </select>

    <select id="Recipe.selectCategoryList" parameterType="Recipe" resultType="Recipe">
        select
        R.*
        ,IFNULL((SELECT 1 FROM RECIPE_FERMENTABLE A WHERE A.brewer = R.brewer AND A.recipe_seq = R.seq LIMIT 1),0)
        +IFNULL((SELECT 1 FROM RECIPE_YEAST A WHERE A.brewer = R.brewer AND A.recipe_seq = R.seq LIMIT 1),0)
        +IFNULL((SELECT 1 FROM RECIPE_HOPS A WHERE A.brewer = R.brewer AND A.recipe_seq = R.seq LIMIT 1),0) as completeness
        FROM (
        <include refid="Recipe.categoryList"/>
        <if test="styleCategory != null">
            AND B.category_number = #{styleCategory}
        </if>
        ORDER BY  seq desc ) R
    </select>


    <select id="Recipe.selectCategoryDetail" parameterType="Recipe" resultType="Recipe">
        <!-- 맥주 레시피 상세 조회 -->
        <include refid="Recipe.categoryList" />
        <if test="seq != null">
            AND A.seq = #{seq}
        </if>
        <if test="name != null">
            AND A.name = #{name}
        </if>
        <if test="brewer != null">
            AND brewer = #{brewer}
        </if>
        <if test="insertId != null">
            AND A.insert_id = #{insertId}
        </if>
    </select>


    <insert id="Recipe.insertRecipe" parameterType="Recipe">
        <!-- 맥주 레시피 저장 -->
        INSERT INTO brewduckdb.RECIPE (
             seq
            ,name
            ,version           
            ,type              
            ,brewer
            ,style_seq
            ,asst_brewer       
            ,batch_size        
            ,boil_size         
            ,boil_time         
            ,efficiency        
            ,notes             
            ,og                
            ,fg                
            ,primary_age       
            ,primary_temp      
            ,secondary_age     
            ,secondary_temp    
            ,age               
            ,age_temp          
            ,priming_sugar_name
            ,insert_id  
            ,insert_date
        ) VALUES (
             #{seq}
            ,#{name}
            ,#{version}
            ,#{type}
            ,#{brewer}
            ,#{styleSeq}
            ,#{asstBrewer}
            ,#{batchSize}
            ,#{boilSize}
            ,#{boilTime}
            ,#{efficiency}
            ,#{notes}
            ,#{og}
            ,#{fg}
            ,#{primaryAge}
            ,#{primaryTemp}
            ,#{secondaryAge}
            ,#{secondaryTemp}
            ,#{age}
            ,#{ageTemp}
            ,#{primingSugarName}
            ,#{insertId}
            ,now()
        )
    </insert>

    <update id="updateRecipe" parameterType="Recipe">
        <!-- 맥주 레시피 수정 -->
        UPDATE brewduckdb.RECIPE
        <trim prefix="SET" suffixOverrides=",">
            <if test="status != null">
                status = #{status},
            </if>
            <if test="atchFileId != null">
                atch_file_id = #{atchFileId},
            </if>
            <if test="atchCoverFileId != null">
                atch_cover_file_id = #{atchCoverFileId},
            </if>
            <if test="name != null">
                name = #{name},
            </if>
            <if test="version != null">
                version = #{version},
            </if>
            <if test="type != null">
                type = #{type},
            </if>
            <if test="asstBrewer != null">
                asst_brewer = #{asstBrewer},
            </if>
            <if test="batchSize != null">
                batch_size = #{batchSize},
            </if>
            <if test="boilSize != null">
                boil_size = #{boilSize},
            </if>
            <if test="boilTime != null">
                boil_time = #{boilTime},
            </if>
            <if test="efficiency != null">
                efficiency = #{efficiency},
            </if>
            <if test="notes != null">
                notes = #{notes},
            </if>
            <if test="og != null">
                og = #{og},
            </if>
            <if test="fg != null">
                fg = #{fg},
            </if>
            <if test="primaryAge != null">
                primary_age = #{primaryAge},
            </if>
            <if test="primaryTemp != null">
                primary_temp = #{primaryTemp},
            </if>
            <if test="secondaryAge != null">
                secondary_age = #{secondaryAge},
            </if>
            <if test="secondaryTemp != null">
                secondary_temp = #{secondaryTemp},
            </if>
            <if test="age != null">
                age = #{age},
            </if>
            <if test="ageTemp != null">
                age_temp = #{ageTemp},
            </if>
            <if test="primingSugarName != null">
                priming_sugar_name = #{primingSugarName},
            </if>
<!--
            <if test="updateId != null">
                read_count = (
                              SELECT (IFNULL(MAX(name), 0) + 1)  read_count
                                FROM brewduckdb.RECIPE
                               WHERE seq  = #{seq}
                                 AND name = #{name}
                             ),
            </if>
-->
            <if test="updateId != null">
                update_id = #{updateId},
            </if>
            <if test="updateId != null">
                update_date = now()
            </if>
        </trim>
        WHERE seq  = #{seq}
          AND brewer = #{brewer}
    </update>

    <update id="deleteRecipe" parameterType="Recipe">
        <!-- 맥주 레시피 삭제 -->
        UPDATE brewduckdb.RECIPE
           SET delete_id = #{deleteId}
              ,delete_date = now()
         WHERE seq  = #{seq}
           AND brewer = #{brewer}
    </update>

    <update id="deleteRecipeFermentable" parameterType="Recipe">
        <!-- 맥주 레시피 삭제 -->
        UPDATE brewduckdb.RECIPE_FERMENTABLE
           SET delete_id = #{deleteId}
              ,delete_date = now()
        WHERE recipe_seq  = #{seq}
          AND brewer = #{brewer}
    </update>

    <update id="deleteRecipeYeast" parameterType="Recipe">
        <!-- 맥주 레시피 삭제 -->
        UPDATE brewduckdb.RECIPE_YEAST
        SET delete_id = #{deleteId}
        ,delete_date = now()
        WHERE recipe_seq  = #{seq}
        AND brewer = #{brewer}
    </update>

    <update id="deleteRecipeHops" parameterType="Recipe">
        <!-- 맥주 레시피 삭제 -->
        UPDATE brewduckdb.RECIPE_HOPS
        SET delete_id = #{deleteId}
        ,delete_date = now()
        WHERE recipe_seq  = #{seq}
        AND brewer = #{brewer}
    </update>

    <update id="deleteRecipeMisc" parameterType="Recipe">
        <!-- 맥주 레시피 삭제 -->
        UPDATE brewduckdb.RECIPE_MISC
        SET delete_id = #{deleteId}
        ,delete_date = now()
        WHERE recipe_seq  = #{seq}
        AND brewer = #{brewer}
    </update>

    <insert id="Recipe.insertRecipeFermentable" parameterType="Recipe">
        INSERT INTO brewduckdb.RECIPE_FERMENTABLE (
            recipe_seq
            ,fermentable_seq
            ,amount
            ,fermentable_use
            ,type
            ,brewer
            ,insert_id
            ,insert_date
        ) VALUES (
             #{recipeSeq} -- seq - IN int(11)
            ,#{recipeFermantableSeq} -- fermentable_seq - IN int(11)
            ,#{recipeFermantableAmount} -- amount - IN double
            ,#{recipeFermantableUse}   -- fermentable_use - IN varchar(10)
            ,#{recipeFermantableType}   -- fermentable_use - IN varchar(10)
            ,#{brewer}   -- fermentable_use - IN varchar(10)
            ,#{insertId} -- insert_id - IN varchar(45)
            ,now() -- insert_date - IN timestamp
        )
    </insert>

    <insert id="Recipe.insertRecipeHop" parameterType="Recipe">
        INSERT INTO brewduckdb.RECIPE_HOPS (
             recipe_seq
            ,hops_seq
            ,brewer
            ,amount
            ,hops_use
            ,time
            ,form
            ,alpha
            ,insert_id
            ,insert_date
        ) VALUES (
             #{recipeSeq} -- seq - IN int(11)
            ,#{recipeHopSeq} -- fermentable_seq - IN int(11)
            ,#{brewer}
            ,#{recipeHopAmount} -- amount - IN double
            ,#{recipeHopUse}   -- fermentable_use - IN varchar(10)
            ,#{recipeHopTime}   -- fermentable_use - IN varchar(10)
            ,#{recipeHopForm}   -- fermentable_use - IN varchar(10)
            ,#{recipeHopAlpha}   -- fermentable_use - IN varchar(10)
            ,#{insertId} -- insert_id - IN varchar(45)
            ,now() -- insert_date - IN timestamp
        )
    </insert>

    <insert id="Recipe.insertRecipeYeast" parameterType="Recipe">
        INSERT INTO brewduckdb.RECIPE_YEAST (
            recipe_seq
            ,yeast_seq
            ,brewer
            ,insert_id
            ,insert_date
        ) VALUES (
             #{recipeSeq} -- seq - IN int(11)
            ,#{recipeYeastSeq} -- fermentable_seq - IN int(11)
            ,#{brewer}
            ,#{insertId} -- insert_id - IN varchar(45)
            ,now() -- insert_date - IN timestamp
        )
    </insert>

    <insert id="Recipe.insertRecipeMisc" parameterType="Recipe">
        INSERT INTO brewduckdb.RECIPE_MISC (
             recipe_seq
            ,misc_seq
            ,brewer
            ,amount
            ,time
            ,misc_use
            ,insert_id
            ,insert_date
        ) VALUES (
             #{recipeSeq} -- seq - IN int(11)
            ,#{recipeMiscSeq} -- fermentable_seq - IN int(11)
            ,#{brewer}
            ,#{recipeMiscAmount} -- amount - IN double
            ,#{recipeMiscTime}   -- fermentable_use - IN varchar(10)
            ,#{recipeMiscUse}   -- fermentable_use - IN varchar(10)
            ,#{insertId} -- insert_id - IN varchar(45)
            ,now() -- insert_date - IN timestamp
        )
    </insert>
</mapper>
